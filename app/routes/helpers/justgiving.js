// Generated by CoffeeScript 1.4.0
(function() {
  var JustGiving, https, parse, _;

  https = require('https');

  parse = require('url').parse;

  _ = require('underscore')._;

  JustGiving = (function() {
    var doApiCall;

    JustGiving.DirectDonatePath = '/donation/direct/charity';

    JustGiving.GetDonationDetails = '/v1/donation/';

    JustGiving.CharitySearch = '/v1/charity/search';

    doApiCall = function(fullUrl, apiKey, callback) {
      var buf, opts, req;
      buf = '';
      opts = {
        headers: {
          'Accept': 'application/json',
          'x-api-key': apiKey
        }
      };
      return req = https.get(_.extend(parse(fullUrl), opts), function(res) {
        console.log("JG: " + fullUrl + " responded with " + res.statusCode);
        if (res.statusCode !== 200 && res.statusCode !== 404) {
          if (typeof callback === "function") {
            callback("status " + res.statusCode);
          }
          req.abort();
        }
        res.on('data', function(data) {
          return buf += data;
        });
        return res.on('end', function() {
          return typeof callback === "function" ? callback(null, JSON.parse(buf)) : void 0;
        });
      }).on('error', function(e) {
        return typeof callback === "function" ? callback(e) : void 0;
      });
    };

    function JustGiving(siteUrl, apiUrl, apiKey) {
      this.siteUrl = siteUrl;
      this.apiUrl = apiUrl;
      this.apiKey = apiKey;
    }

    JustGiving.prototype.getDonationUrl = function(charityId, callbackUrl, ourData, thirdPartyReference, amount) {
      var url;
      url = this.siteUrl + JustGiving.DirectDonatePath;
      url += "/" + charityId + "?frequency=single";
      if (amount != null) {
        url += "&amount=" + amount;
      }
      if (thirdPartyReference != null) {
        url += "&reference=" + encodeURIComponent(thirdPartyReference);
      }
      url += "&exitUrl=" + encodeURIComponent(callbackUrl + ("?id=JUSTGIVING-DONATION-ID&data=" + (encodeURIComponent(ourData))));
      return url;
    };

    JustGiving.prototype.getDonationStatus = function(donationId, callback) {
      var url;
      url = this.apiUrl + JustGiving.GetDonationDetails + donationId;
      return doApiCall(url, this.apiKey, callback);
    };

    JustGiving.prototype.charitySearch = function(query, pageSize, page, callback) {
      var url;
      if (pageSize == null) {
        pageSize = 4;
      }
      if (page == null) {
        page = 1;
      }
      url = this.apiUrl + JustGiving.CharitySearch;
      url += "?q=" + query;
      if (pageSize) {
        url += "&pageSize=" + pageSize;
      }
      if (page) {
        url += "&page=" + page;
      }
      return doApiCall(url, this.apiKey, callback);
    };

    return JustGiving;

  })();

  module.exports = JustGiving;

}).call(this);
